@{
    Layout = null;
    var insulin = ViewBag.Insulin != null ? ViewBag.Insulin : "";
    var insulinCorrection = ViewBag.InsulinCorrection != null ? ViewBag.InsulinCorrection : "";
    var insulinTotal = ViewBag.InsulinTotal != null ? ViewBag.InsulinTotal : "";
}

<!DOCTYPE html>
<html>
<head>
    <title>Insulin Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="~/css/styles.css" asp-append-version="true">
    <script>
        const ratios = {
            "Breakfast": 22,
            "Lunch": 18,
            "Dinner": 15,
            "Supper": 28
        };

        function roundToNearestHalf(num) {
            return Math.round(num * 2) / 2;
        }

        function updateValues() {
            const selectedMeal = document.querySelector('.meal-option.selected');
            if (!selectedMeal) return;

            const meal = selectedMeal.getAttribute("data-meal");
            const bgLevel = parseFloat(document.getElementById("bgLevel").value) || 0;
            const mealCarbs = parseFloat(document.getElementById("mealCarbs").value) || 0;

            const ratio = ratios[meal] || 0;
            document.getElementById("meal-ratio").textContent = `1:${ratio}`;

            const insulin = mealCarbs / ratio;
            const roundedInsulin = roundToNearestHalf(insulin);

            const correction = bgLevel > 10 ? 2.5 : 0;

            const insulinTotal = roundedInsulin + correction;

            document.getElementById("insulin").textContent = insulin.toFixed(2);
            document.getElementById("roundedInsulin").textContent = roundedInsulin;
            document.getElementById("insulinCorrection").textContent = correction;
            document.getElementById("insulinTotal").textContent = insulinTotal;
        }

        function selectMeal(mealElement) {
            const options = document.querySelectorAll('.meal-option');
            options.forEach(opt => opt.classList.remove('selected'));
            mealElement.classList.add('selected');
            updateValues();
        }

        document.addEventListener("DOMContentLoaded", () => {
            document.getElementById("bgLevel").addEventListener("input", updateValues);
            document.getElementById("mealCarbs").addEventListener("input", updateValues);

            const mealOptions = document.querySelectorAll('.meal-option');
            mealOptions.forEach(option => {
                option.addEventListener('click', function () {
                    selectMeal(this);
                });
            });
        });
    </script>
</head>
<body>
    <div class="container">
        <h2>Insulin Calculator</h2>

        <div class="meal-picker">
            <div class="meal-option" data-meal="Breakfast">Breakfast</div>
            <div class="meal-option" data-meal="Lunch">Lunch</div>
            <div class="meal-option" data-meal="Dinner">Dinner</div>
            <div class="meal-option" data-meal="Supper">Supper</div>
        </div>

        <table>
            <tr>
                <td class="label">Ratio</td>
                <td id="meal-ratio">1:22</td>
            </tr>
            <tr>
                <td class="label">BG (mmol/L)</td>
                <td><input type="number" id="bgLevel" name="bgLevel" required /></td>
            </tr>
            <tr>
                <td class="label">Meal Carbs (g)</td>
                <td><input type="number" id="mealCarbs" name="mealCarbs" required /></td>
            </tr>
            <tr>
                <td class="label">Insulin</td>
                <td id="insulin"></td>
            </tr>
            <tr>
                <td class="label">Insulin Rounded</td>
                <td id="roundedInsulin"></td>
            </tr>
            <tr>
                <td class="label">Insulin Correction</td>
                <td id="insulinCorrection"></td>
            </tr>
            <tr>
                <td class="label result">Insulin Total</td>
                <td class="result" id="insulinTotal"></td>
            </tr>
        </table>
    </div>
</body>
</html>
